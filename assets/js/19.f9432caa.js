(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{464:function(s,a,n){"use strict";n.r(a);var t=n(36),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"docker-swarm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-swarm"}},[s._v("#")]),s._v(" Docker Swarm")]),s._v(" "),a("p",[s._v("Swarm是Docker官方提供的一款集群管理工具，其主要作用是把若干台 Docker 主机抽象为一个整体，并且通过一个入口统一管理这些Docker主机上的各种Docker资源。")]),s._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"http://c.biancheng.net/view/3176.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("推荐阅读：Docker Swarm简介"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://blog.csdn.net/lypgcs/article/details/104259981",target:"_blank",rel:"noopener noreferrer"}},[s._v("部署docker swarm集群监控"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/fundebug/p/6823897.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("生产环境中使用Docker Swarm的一些建议"),a("OutboundLink")],1)])]),s._v(" "),a("h3",{attrs:{id:"哪些适合上swarm"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#哪些适合上swarm"}},[s._v("#")]),s._v(" 哪些适合上Swarm")]),s._v(" "),a("ol",[a("li",[s._v("无状态的容器就非常适合部署在Swarm集群，它们可以由环境变量进行配置(使用ENV指令)。建议为开源工具构建镜像，例如，可以将Nginx的配置文件放到Docker镜像中。")]),s._v(" "),a("li",[s._v("部署在Swarm集群之外的容器：数据库（MySQL）、缓存（Redis）")]),s._v(" "),a("li",[s._v("当你开启一个服务的端口之后，在Swarm集群中的任何一个节点都可以访问它。负载均衡也是由Swarm提供的。")])]),s._v(" "),a("h3",{attrs:{id:"基本概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基本概念"}},[s._v("#")]),s._v(" 基本概念")]),s._v(" "),a("ol",[a("li",[s._v("单引擎（Single-Engine）模式： 不包含在任何 Swarm 中的 Docker 节点。")]),s._v(" "),a("li",[s._v("Swarm 模式： 一旦被加入 Swarm 集群。在单引擎模式下的 Docker 主机上运行 docker swarm init 会将其切换到 Swarm 模式，并创建一个新的 Swarm，将自身设置为 Swarm 的第一个管理节点。")])]),s._v(" "),a("ul",[a("li",[s._v("Swarm网络\n"),a("ul",[a("li",[s._v("2377/tcp：用于客户端与 Swarm 进行安全通信。")]),s._v(" "),a("li",[s._v("7946/tcp 与 7946/udp：用于控制面 gossip 分发。")]),s._v(" "),a("li",[s._v("4789/udp：用于基于 VXLAN 的覆盖网络。")])])])]),s._v(" "),a("p",[s._v("Swarm 模式下的dnsrr只对内部访问，vip：虚拟专用网，会进行负载均衡，各个节点都能访问。一个服务可以定义多个网络，这个服务就可以被多个网络访问")]),s._v(" "),a("p",[s._v("搭建步骤：初始化第一个管理节点 -> 加入额外的管理节点 -> 加入工作节点 -> 完成")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 初始化swarm管理节点")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" swarm init "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--advertise-addr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1:2377 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--listen-addr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".0.1:2377\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 工作节点")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出 Swarm 中的节点。")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 本地测试环境")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 注意：管理不能有集群存储模式，例如--cluster-store and --cluster-advertise daemon")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 如果有，需要修改，修改命令参考（vim /lib/systemd/system/docker.service | systemctl daemon-reload && systemctl restart docker）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" swarm init "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--advertise-addr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".2.106:2377 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--listen-addr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".2.106:2377\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 初始化完成后会有提示：")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Swarm initialized: current node (q6jiy9n8hydc71dqdv9wl2kd2) is now a manager.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# To add a worker to this swarm, run the following command:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# docker swarm join --token SWMTKN-1-05dvket41nnkhwiuijshcx98visd9uq3s5dnlnsosw6wof8ptp-1dxk9zpeopgb6d9zk8tmcmfhv 192.168.2.106:2377")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## swarm添加work节点（docker swarm join-token worker： 展示添加工作节点命令）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" swarm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--token")]),s._v(" SWMTKN-1-05dvket41nnkhwiuijshcx98visd9uq3s5dnlnsosw6wof8ptp-1dxk9zpeopgb6d9zk8tmcmfhv "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".2.106:2377\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## swarm添加管理节点（docker swarm join-token manager： 展示添加管理节点命令, 尽可能指出advertise-addr与listen-addr实际IP地址）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" swarm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--token")]),s._v(" SWMTKN-1-05dvket41nnkhwiuijshcx98visd9uq3s5dnlnsosw6wof8ptp-ccyr5f9trow8v313mj7g4218p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".2.106:2377 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--advertise-addr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".2.109:2377 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n--listen-addr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".2.109:2377\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#### 注意：管理节点也可以同时作为work节点")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 查看swarm集群节点")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 在swarm集群中创建网络（只能在管理节点上创建）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" network create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" overlay "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--attachable")]),s._v(" ctfx\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 查看刚创建的网络信息")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" network inspect ctfx\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 测试网络通信，任意两个节点上和子节点上分别执行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-itd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("leo_zhou1 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--net")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ctfx  busybox  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动容器，加入刚创建的ctfx网络")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" run "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-itd")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("leo_zhou2 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--net")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ctfx  busybox  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启动容器，加入刚创建的ctfx网络")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" leo_zhou1 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" leo_zhou2\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 将work节点提升为管理节点(高可用的集群中至少要有三个节点)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" promote vm511  \n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 取消管理节点，将其降为work节点")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" demote vm512\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#############################################")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 在swarm集群中创建服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" test1 alpine "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" www.baidu.com\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 查看swarm集群中服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" inspect test1\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 查看swarm集群中服务日志")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" logs "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" test1\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 测试nginx服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--detach")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false nginx\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 更新服务(开放nginx的8080端口，开放后，任意节点的http://IP:8080都可以访问到nginx)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" update --publish-add "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":80 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--detach")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false nginx\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 扩充服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" scale "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("nginx")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 查看服务进程，编辑页面，测试其负载均衡。测试结论：轮训在三个节点上访问")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" nginx\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" 807c27a26ba5 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"I am the test nginx"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /usr/share/nginx/html/index.html\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 关闭swarm服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" nginx test1\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 测试swarm自定义网络")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--network")]),s._v(" ctfx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" nginx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v(":80 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--detach")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false nginx\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--network")]),s._v(" ctfx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" test1 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--detach")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false alpine "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ping")]),s._v(" www.baidu.com\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" alpine\n\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" create "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" nginx-b --endpoint-mode dnsrr "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--detach")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false nginx\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 更新nginx-b网络服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" update --network-add ctfx "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--detach")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false nginx-b\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#############################################")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stack  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 可以定义一组服务，相当于compose")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stack deploy "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" service.yaml "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在swarm上部署service.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stack deploy --compose-file docker-stack.yml vote\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在swarm上部署docker-stack.yml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stack services "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看服务 ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stack "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 展示服务")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stack "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 展示进程部署")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" stack "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("rm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看服务 ")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"3.4"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n   "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alpine")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alpine\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ping"')]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"www.baidu.com"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ctfx"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t   "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoint_mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" dnsrr\n       "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n       "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restart_policy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("condition")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" on"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("failure\n       "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpus")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.1"')]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 50M\n\t   "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("placement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("constraints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" node.role == manager "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这个服务只会放在管理节点上，参考下面的部署约束")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nginx\n   "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nginx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ctfx"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"8080:80"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ctfx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("external")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("h3",{attrs:{id:"服务编排"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务编排"}},[s._v("#")]),s._v(" 服务编排")]),s._v(" "),a("ol",[a("li",[s._v("服务部署 && 服务发现")]),s._v(" "),a("li",[s._v("服务更新： docker service update ...")]),s._v(" "),a("li",[s._v("服务扩缩容： docker service scale ...")])]),s._v(" "),a("p",[s._v("swarm网络模式： ingress、ingress-link、dnsrr")]),s._v(" "),a("p",[s._v("vip: 负载均衡模式，可以通过浏览器访问"),a("br"),s._v("\ndnsrr： 只能开放给那些在容器间通过名字来进行互相访问提供服务的。不对外提供服务。")]),s._v(" "),a("p",[s._v("如果我们的服务不需要提供给客户端访问，可以定义为dnsrr的方式。")]),s._v(" "),a("p",[s._v("以交互方式，进入nginx镜像内看看"),a("br"),s._v("\ndocker run -it --entrypoint bash nginx")]),s._v(" "),a("p",[s._v("查看swarm证书："),a("br"),s._v("\nopenssl x509 -in /var/lib/docker/swarm/certificates/swarm-node.crt -text")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("mysql、redis、nsq等基础服务，使用docker单机模式配置在固定的节点上。不要放在集群中。")])]),s._v(" "),a("p",[a("strong",[s._v("部署约束")]),s._v("（可以指定服务部署在哪一台节点上或者具有哪一类特征的节点上）：")]),s._v(" "),a("ol",[a("li",[s._v("节点ID，如 node.id==o2p4kw2uuw2a。")]),s._v(" "),a("li",[s._v("节点名称，如 node.hostname==wrk-12。")]),s._v(" "),a("li",[s._v("节点角色，如 node.role!=manager。")]),s._v(" "),a("li",[s._v("节点引擎标签，如 engine.labels.operatingsystem==ubuntu16.04。")]),s._v(" "),a("li",[s._v("节点自定义标签，如 node.labels.zone==prod1。")])]),s._v(" "),a("p",[s._v("配置文件中四类顶级关键词理解：")]),s._v(" "),a("ol",[a("li",[s._v("version: 版本，在没有yaml文件中第一行都会有，指定compose编写时对应的版本（例如：2.2、3.2、3.4），不要理解为该文档编辑的不同版本。")]),s._v(" "),a("li",[s._v("services: 服务，定义整个应用服务，是必需要自定义给的，描述了各个应用服务需要的各种资源等信息。")]),s._v(" "),a("li",[s._v("networks: 网络，定义该compose使用的网络，网络可提前创建，也可以启动时创建，可以使用加密网络。")]),s._v(" "),a("li",[s._v("secrets: 密钥，定义出各种密钥，用于给服务、网络使用。")])]),s._v(" "),a("h3",{attrs:{id:"docker密钥管理和使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker密钥管理和使用"}},[s._v("#")]),s._v(" Docker密钥管理和使用")]),s._v(" "),a("ol",[a("li",[a("a",{attrs:{href:"https://www.jianshu.com/p/cc942f57f75e",target:"_blank",rel:"noopener noreferrer"}},[s._v("Docker-Secret管理和使用"),a("OutboundLink")],1)])]),s._v(" "),a("ul",[a("li",[s._v("什么可以作为Secret（将密码用文件保存后，给文件起个名称，然后用docker管理，编写services时使用）\n"),a("ul",[a("li",[s._v("用户名密码")]),s._v(" "),a("li",[s._v("SSH Key")]),s._v(" "),a("li",[s._v("TLS认证")]),s._v(" "),a("li",[s._v("任何不想让别人看到的数据")])])])]),s._v(" "),a("p",[s._v("创建密钥命令\ndocker secret")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看docker中已经创建的密钥")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" secret "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v("\n \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("## 把密码放入一个文件里，例如password ")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"adminadmin"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" ./password\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建一个名为my-pwd的密钥")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" secret create my-pwd password\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 然后就可以在compose中根据名称来进行引用。")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h3",{attrs:{id:"docker-swarm部署总结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker-swarm部署总结"}},[s._v("#")]),s._v(" Docker-Swarm部署总结")]),s._v(" "),a("p",[a("strong",[s._v("一、NSQ集群部署示例及总结")])]),s._v(" "),a("ol",[a("li",[s._v("docker-stack-nsq.yml如下")])]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'3.4'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("services")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nsqlookupd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nsqio/nsq\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /nsqlookupd\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"4160:4160"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"4161:4161"')]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#  - "4160"    # 系统自动分配端口')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#  - "4161"\t   # 系统自动分配端口')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#deploy:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  placement:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     constraints: [ node.hostname==vm511 ]")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nsq\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nsqd")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nsqio/nsq\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /nsqd "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("lookupd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tcp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("address=nsqlookupd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4160")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nsqlookupd\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"4150:4150"')]),s._v("\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# TCP端口")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('#  - "4151:4151"\t# HTTP端口')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nsq\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nsqadmin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nsqio/nsq\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /nsqadmin "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("lookupd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("address=nsqlookupd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4161")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("depends_on")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nsqlookupd\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"4171:4171"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#deploy:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#  placement:")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#     constraints: [ node.hostname==vm511 ]   # 该服务只会部署在vm511主机上")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nsq\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networks")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nsq")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("driver")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" overlay\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("总结如下：")])]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("NSQ集群总结")]),s._v(" "),a("ol",[a("li",[s._v("docker stack的Yaml文件中，每个service配置中不需要配置容器名称，因为部署后，stack会根据service自动分配名称，例如上述nsqadmin，启动后会生成nsqadmin.1名称")]),s._v(" "),a("li",[s._v("部署后，整个集群内的节点都可以访问（即使某个节点没有服务启动，只要这个节点属于集群，该节点也会自动开放已启动的服务端口，例如nsqadmin只在vm511节点启动的，在vm512、vm513都可以访问该服务）")]),s._v(" "),a("li",[s._v("一个stack配置文件作为一个整体，只需配置具体某个服务，如果服务需要部署多个，只需配置副本数（replicas），在每个节点都可以看到开放的端口。")]),s._v(" "),a("li",[s._v("在stack中，尽量明确哪些端口需要对外暴露，如果不需要，则不要在配置中对外开放。如要的话，对外标清楚。如果出现30002、30003类似端口，这个是系统随机端口，尽量不要独自分配端口。")])])]),s._v(" "),a("p",[s._v("实现零宕机部署也非常简单。这样也可以方便地实现持续部署:")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 构建新镜像")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" build "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" hub.docker.com/image "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将新镜像上传到Docker仓库")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" push hub.docker.com/image\n \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新服务的镜像")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("docker")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" update "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),s._v(" hub.docker.com/image "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])])])}),[],!1,null,null,null);a.default=e.exports}}]);